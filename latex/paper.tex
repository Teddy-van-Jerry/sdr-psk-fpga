\documentclass[journal,twoside]{IEEEtran}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{multicol,multirow}
\usepackage{newtxmath}
\usepackage{mathtools}
\usepackage{bm}
\usepackage[caption=false,font=footnotesize,subrefformat=parens]{subfig}
\usepackage{lipsum}
\usepackage{tabularx}
\usepackage[dvipsnames,table]{xcolor}
\usepackage{my-tikz}
\usepackage{colortbl}
\usepackage{scalerel}
\usepackage{threeparttable}
\usepackage{algorithm}
\usepackage[italicComments=false,commentColor=darkgray,noEnd=true]{algpseudocodex}
\usepackage{upgreek}
\usepackage{calc}
\usepackage[noadjust]{cite}
\usepackage{circuitikz}
\usepackage{siunitx}
\usepackage{minted}
\usepackage[colorlinks,urlcolor=black,linkcolor=blue,citecolor=blue]{hyperref}

\usetikzlibrary{svg.path,shapes.symbols,shapes.misc}
\definecolor{orcidlogocol}{HTML}{A6CE39}
\tikzset{
  orcidlogo/.pic={
    \fill[orcidlogocol] svg{M256,128c0,70.7-57.3,128-128,128C57.3,256,0,198.7,0,128C0,57.3,57.3,0,128,0C198.7,0,256,57.3,256,128z};
    \fill[white] svg{M86.3,186.2H70.9V79.1h15.4v48.4V186.2z}
                 svg{M108.9,79.1h41.6c39.6,0,57,28.3,57,53.6c0,27.5-21.5,53.6-56.8,53.6h-41.8V79.1z M124.3,172.4h24.5c34.9,0,42.9-26.5,42.9-39.7c0-21.5-13.7-39.7-43.7-39.7h-23.7V172.4z}
                 svg{M88.7,56.8c0,5.5-4.5,10.1-10.1,10.1c-5.6,0-10.1-4.6-10.1-10.1c0-5.6,4.5-10.1,10.1-10.1C84.2,46.7,88.7,51.3,88.7,56.8z};
  }
}

\newcommand\orcidicon[1]{\href{https://orcid.org/#1}{\mbox{\scalerel*{
  \begin{tikzpicture}[yscale=-1,transform shape]
    \pic{orcidlogo};
  \end{tikzpicture}
}{|}}}}

% \makesavenoteenv{tabular}
\interdisplaylinepenalty=2500
\aboverulesep = 0mm \belowrulesep = 0mm
\newcolumntype{Y}{>{\centering\arraybackslash}X}
\newcolumntype{M}[1]{>{\centering\arraybackslash}m{#1}} % centered m
\newcommand{\tabvertspace}{\specialrule{0em}{0.08em}{.08em}}

\definecolor{doicolor}{RGB}{2, 48, 129}

\DeclareMathOperator*{\argmax}{\arg\max}
\DeclareMathOperator*{\argmin}{\arg\min}
\DeclareMathOperator*{\argmint}{\widetilde{\arg\min}}
\DeclareMathOperator*{\uargmin}{\mathrm{u}\arg\min}

\setlength{\fboxsep}{0pt}
\setminted{
  , frame = lines
  , fontsize = \scriptsize
  , bgcolor = gray!3
  , framesep = 2.5pt
}

\markboth{Southeast University Software-Defined Radio Experiment Course, January 2024}{W. Zhao: Dual-Mode PSK Transceiver on SDR With FPGA}
\IEEEpubid{
  \begin{tabular}[t]{c}
    \copyright{} 2024 Wuqiong Zhao.
    This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 License.\\
    For more information, see \url{https://creativecommons.org/licenses/by-sa/4.0/}.
  \end{tabular}
}

\hypersetup{
  , pdftitle    = {Dual-Mode {PSK} Transceiver on {SDR} With {FPGA}}
  , pdfauthor   = {Wuqiong Zhao}
  , pdfsubject  = {Southeast University Software-Defined Radio Experiment Course}
  , pdfkeywords = {Phase-shift keying (PSK), software-defined radio (SDR), transceiver design, modulation, demodulation, field programmable gate array (FPGA).}
}

\begin{document}

  \title{Dual-Mode PSK Transceiver on SDR With FPGA}

  \author{%
    Wuqiong~Zhao{\hspace{.1em}\textsuperscript{\orcidicon{0000-0002-9550-7423}}},~\IEEEmembership{Student Member, IEEE}
    \thanks{Date of publication 4 January 2024; date of current version 4 January 2024.
      The author would like to thank Lecturer Dan Yang for the guidance and help in the course of the experiment.
      The author would also like to thank AI tools including GitHub Copilot and Claude.AI for their help in preparing this paper.}
    \thanks{Wuqiong Zhao is with Southeast University, Nanjing 211189, China. (e-mail: wqzhao@seu.edu.cn, website: \url{https://wqzhao.org}).}
    \thanks{Online URL: \url{https://go.wqzhao.org/sdr-psk-fpga}}
    % \vspace{-1mm}
  }

  \maketitle

  \begin{abstract}
    In this experiment, we implement a dual-mode PSK transceiver on SDR with FPGA,
    supporting both BPSK and QPSK.
    Moreover, the transceiver is designed to be able to switch between the two modes by introducing packet-based communication,
    where modulation information can be extracted from the packet header.
  \end{abstract}
  \begin{IEEEkeywords}
    Phase-shift keying (PSK), software-defined radio (SDR), transceiver design, modulation, demodulation, field programmable gate array (FPGA).
  \end{IEEEkeywords}

  \section{Introduction}

    \IEEEPARstart{S}{oftware-defined} radio (SDR) is interesting, like application in millimeter wave \cite{zhao2020m}.
    FPGA is also interesting!

    Instead of employing high-level synthesis (HLS) \cite{zhao2023flexible},
    we directly implement the transceiver on FPGA using hardware description language (HDL) Verilog,
    for a better control of the underlying hardware.

    The design source (Vivado project) and this paper (in \LaTeX) are open source \cite{github_repo}.
    

  \section{System Overview}

    \subsection{Software-Defined Radio}

    \subsection{Transceiver Design}

      The current transmitter and receiver are implemented on the same FPGA,
      but can be readily extended to different FPGAs with small frequency offsets.
      The system overview is shown in Fig.~\ref{fig:system_overview}.
      \begin{figure}[htbp]
        \centering
        \input{tikz/transceiver_design}
        \caption{Transceiver system overview.}
        \label{fig:system_overview}
      \end{figure}

      \textbf{Clock Generator}.
      All reset signals are generated using Processor System Reset Modules \cite{xilinx:pg164},
      which can provide synchronized power-up reset signals.

      \textbf{RF Data Converter}.
      This block is contains analog-to-digital converter (ADC) and digital-to-analog converter (DAC),
      enabled by a vendored AD9361 module.

      \textbf{Tx Signal Generator}.

      \textbf{Rx Processor}.

      \textbf{System ILA}.
      The system integrated logic analyzer (system ILA) \cite{xilinx:pg261} is used to observe the internal signals.

      \textbf{Constant Configurations}.
      Several parameters can be configured in this block.
      Most importantly, the mode control constants (\texttt{MODE\_CTRL}) are shown in Table~\ref{tab:mode_ctrl}.
      \begin{table}[htbp]
        \caption{Mode Control Constants}
        \label{tab:mode_ctrl}
        \renewcommand{\arraystretch}{1.2}
        \rowcolors{1}{white}{gray!15}
        \begin{tabularx}{\linewidth}{cYYYc}
          \toprule\tabvertspace
          \textbf{Mode} & \textbf{Localparam} & \textbf{Value} & \textbf{\ttfamily is\_bpsk} & \textbf{Packet} \\
          \tabvertspace\midrule
            BPSK & \texttt{MODE\_BPSK} & \texttt{4\textquotesingle b0001} (1) & \texttt{1\textquotesingle b1} & No \\
            QPSK & \texttt{MODE\_QPSK} & \texttt{4\textquotesingle b0010} (2) & \texttt{1\textquotesingle b0} & No \\
            Mixed & \texttt{MODE\_MIX~~} & \texttt{4\textquotesingle b0100} (4) & variable & Yes \\
          \bottomrule
        \end{tabularx}
      \end{table}

    \subsection{BPSK/QPSK Modulation}

      The BPSK and QPSK modulation constellation graphs used in our system are shown in Fig.~\ref{fig:constellation}.
      Different from the traditional setting, out adopted BPSK constellation in Fig.~\subref*{subfig:constellation_BPSK}
      is a combination of I and Q components.
      \begin{figure}[htbp]
        \subfloat[BPSK.\label{subfig:constellation_BPSK}]{\input{tikz/mod_BPSK}}\hfill%
        \subfloat[QPSK.\label{subfig:constellation_QPSK}]{\input{tikz/mod_QPSK}}
        \caption{BPSK/QPSK modulation constellation used in our system.}
        \label{fig:constellation}
      \end{figure}

    \IEEEpubidadjcol
    \section{Transmitter}

    \subsection{Carrier NCO}

      The carrier frequency is generated by a numerically controlled oscillator (NCO).
      In Vivado, we use the Direct Digital Synthesis (DDS) Compiler IP core to generate the NCO.

  \subsection{PSK Modulation}

    \subsection{Pseudo-random Noise (PN) Generator}

      In this experiment, the transmitted signal are pseudo-random noise (PN) sequences.
      Typically, we implement the PN generator with $N=4$ and $N=5$. % mention the structure here

      \newpage
      The Verilog code for the module \texttt{PN\_Gen} is shown below.
      \begin{minted}[highlightlines={11,18}]{verilog}
module PN_Gen # (parameter N = 5) (
  input      clk,
  output reg pn
);
  reg [N-1:0] PN_buf = 1; wire rst;
  generate
  if (N == 5)
    always @ (posedge clk)
      if (rst) begin PN_buf <= 5'd1; pn <= 0; end
      else begin
        PN_buf <= { PN_buf[3:0], PN_buf[4] ^ PN_buf[2] };
        pn <= PN_buf[4];
      end
  else if (N == 4)
    always @ (posedge clk)
      if (rst) begin PN_buf <= 4'd1; pn <= 0; end
      else begin
        PN_buf <= { PN_buf[2:0], PN_buf[3] + PN_buf[2] };
        pn <= PN_buf[3];
      end
  else ; // NOT implemented yet!
  endgenerate
  assign rst = !(|PN_buf);  // reset when PN_buf is all 0
endmodule
      \end{minted}

  \section{Receiver}

    \subsection{Overview}

    \subsection{Carrier Synchronization Using Costas Loop}

      Costas loop \cite{simon1977optimum}.

      \begin{figure}[htbp]
        \centering
        \input{tikz/costas_loop}
        \caption{Costas loop for carrier synchronization with BPSK/QPSK support.}
      \end{figure}

      \begin{minted}[]{verilog}
if (is_bpsk) begin // BPSK
  out_I_tdata <= in_I_tvalid ? in_I_tdata + in_Q_tdata : 0;
  out_Q_tdata <= in_Q_tvalid ? in_I_tdata - in_Q_tdata : 0;
end
else begin // QPSK
  out_I_tdata <= in_I_tvalid ? (in_Q_tdata[WIDTH-1] ?
    -in_I_tdata : in_I_tdata) >>> 6 : 0;
  out_Q_tdata <= in_Q_tvalid ? (in_I_tdata[WIDTH-1] ?
    -in_Q_tdata : in_Q_tdata) >>> 6 : 0;
end
      \end{minted}

    \subsection{Symbol Synchronization Using Gardner Loop}

      A Gardner loop \cite{gardner1986bpsk} is used to achieve symbol (timing) synchronization.
      The structure of a Gardner loop is shown in Fig.~\ref{fig:gardner_loop}.
      \begin{figure}[htbp]
        \input{tikz/gardner_loop}
        \caption{Structure of a Gardner loop for symbol timing synchronization.}
        \label{fig:gardner_loop}
      \end{figure}

      To reduce implementation complexity, we use the sign of strobe values as mentioned in \cite{gardner1986bpsk}.
      The total symbol timing error considering I and Q components is
      \begin{equation}
        \begin{aligned}
          u_t(r)&=y_I(r-\tfrac12)\left[\mathrm{sgn}\left(y_I(r)\right)-\mathrm{sgn}\left(y_I(r-1)\right)\right] \\
          &\quad{}+y_Q(r-\tfrac12)\left[\mathrm{sgn}\left(y_Q(r)\right)-\mathrm{sgn}\left(y_Q(r-1)\right)\right],
        \end{aligned}
      \end{equation}
      where $r$ has a symbol frequency of \qty{1.024}{MHz}.
      For better timing performance, we linearly interpolate the \qty{16.385}{MHz} input I/Q data to \qty{32.768}{MHz}.
      Therefore, $y_I(r-1)$ and $y_Q(r-1)$ are delayed by 32 clocks.
      In FPGA implementation, for each I/Q stream, two shift registers of depth 16 are used.
      Notably, since we adopt the BPSK constellation in Fig.~\subref*{subfig:constellation_BPSK},
      the symbol timing error depends on both I and Q components, the same as QPSK.

  \section{Packet-Based Communication}

    \subsection{Frame Structure}

      The frame structure is shown in Fig.~\ref{fig:frame_structure}.
      \begin{figure}[htbp]
        \centering
        \input{tikz/frame_structure}
        \caption{Frame structure of the packet-based communication.}
        \label{fig:frame_structure}
      \end{figure}

    \textbf{Training (TRN)}.
    The training field is used to provide packet timing information (coarse synchronization),
    as well as synchronize the carrier and symbol timing.
    It consists of 7 repetitions of $\mathbf{D}$ and one $\overline{\mathbf{D}}$,
    where $\mathbf{D}$ and $\overline{\mathbf{D}}$ are of length 32.
    $\mathbf{D}$ and $\overline{\mathbf{D}}$ are repetitive sequences of `01' and `10', respectively.
    The training field from bit $0$ to $(7+1)\times32-1=255$ is defined as
    \begin{equation}
      \mathrm{TRN}[i]=\begin{cases}
        \mathrm{mod}(i,2), & i=0,1,\dots,223,\\
        \mathrm{mod}(i+1,2), & i=224,225,\dots,255.
      \end{cases}
    \end{equation}
    Notably, the phase transition from bit 223 to 224 is used to indicate the boundary of the packet.

    \textbf{Header (HDR)}.
    The header field is used to provide packet information,
    including the modulation and coding scheme (MCS) and the packet length (Length) in bits.
    The remaining bits are reserved for future use.
    The MCS field currently only determines the use of BPSK or QPSK.
    The MCSs for BPSK and QPSK are defined as `01010101' and `10101010' respectively.

    \textbf{Payload (PLD)}.
    The payload field is used to carry the actual data.
    Its length in bits (1 bit for each BPSK symbol, 2 bits for each QPSK symbol) should match the Length field in the header.

    \subsection{Packetizer Design}

    \subsection{Depacketizer Design}

    \subsection{SPB Detection}

      \subsubsection{Strength Detection (SD)}

      \subsubsection{Packet Detection (SD)}

      \subsubsection{Boundary Detection (BD)}

  \section{Simulation Results}

    \subsection{Transmitter}

    \subsection{BPSK-Mode Receiver}

    \subsection{QPSK-Mode Receiver}

    \subsection{Mixed-Mode Receiver}

  \section{Experiment Results on SDR}

    The design is implemented in Vivado 2022.2.
    The experiment results are observed via a system ILA in Vivado,
    and 4 general-purpose input/output (GPIO) pins are used to output some 1-bit signals,
    including the 1-bit Tx and Rx data stream and their corresponding clock.

    \begin{figure*}[t]
      \centering
      \subfloat[BPSK packet data (duration: \qty{200}{\micro\second}).\label{subfig:scope_bpsk}]{\input{tikz/scope/BPSK}}\\
      \subfloat[QPSK packet data (duration: \qty{100}{\micro\second}).\label{subfig:scope_qpsk}]{\input{tikz/scope/QPSK}}\\
      \subfloat[Symbol timing clock and BPSK data at Rx (duration: \qty{50}{\micro\second}).\label{subfig:scope_timing}]{\input{tikz/scope/timing}}
      \caption{Two-channel oscilloscope results.}
      \label{fig:scope}
    \end{figure*}

  \section{Discussions}

    \subsection{Possible Enhancement}

      \textbf{Frame structure design}.
      CRC and/or checksums can be added to the frame structure.

      \textbf{Changing parameters on the fly}.
      AXI peripheral \cite{xilinx:pg127} can be used to change the parameters in the \texttt{Constant\_Config} on the fly,
      if the board allows.

    \subsection{Possible Extensions Beyond the Experiment}

      The training (TRN) field can be better utilized for additional experiments.
      For example, signal-to-noise (SNR) can be estimated at the TRN field.

      Channel estimation algorithm \cite{zhao2023ompl,you2023beam}.

      Auto generation \cite{zhao2023automatic}.

  \section{Conclusion}

    In this paper,


  \appendices

  \section{Block Diagrams}

  \bibliographystyle{IEEEtran}
  \bibliography{IEEEabrv, ref}

\end{document}
